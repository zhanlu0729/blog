# Sentinel(分布式系统的流量防卫兵)手册
## 一、前言
```
随着微服务的流行，服务和服务之间的稳定性变得越来越重要，如果系统在没有任何保护措施的情况下，出现瞬时突发流量冲击，大到后台系统所能承受的极限，就会导致整体系统不可用,从而造成巨大损失.
Sentinel以流量为切入点，从流量控制、熔断降级、系统负载保护等多个维度保护服务的稳定性.
就流控单从本质上而言,是以牺牲部分用户的可用性为代价,来换取先入用户的可用性.
```
## 二、基础概念
### 2.1 资源
```
资源是Sentinel的关键概念.
在这里，我们可以把资源理解为应用程序中的任何内容,大则一个服务群、中则集群中的一个服务实例、小则服务实例内的一个URL请求路径或方法签名、微则一段代码块.
大部分情况下，我们可以使用方法签名、URL、服务名称来作为资源名来表示资源.
```
### 2.2 规则
```
围绕资源的实时状态设定的一系列规则,包括流控规则、降级规则、热点参数规则、系统规则、授权规则.同一个资源可以创建多条限流规则.
```
### 2.3 限流：料事于先
```
限流：限指的是限制，那么“流”呢？在不同的场景对“流”的定义又有很大不同，可以是网络流量、带宽、每秒处理的事务数(TPS)、每秒处理的请求数、并发请求数，又或者是业务上的某个指标.
限流是指对服务的并发访问量进行限制，设置单位时间内的并发数，超出限制的请求被拒绝并fallback，防止后台服务被冲垮
```
### 2.4 熔断：亡羊补牢
```
服务熔断指的是当某个服务提供者不能正常为服务调用者提供服务时,比如请求超时、服务异常等,为了防止整个系统出现雪崩效应暂时将出现故障的接口隔离出来，断绝与外部接口的联系，
当触发熔断后，后续一段时间内该服务调用者的请求都会直接失败，直到目标服务恢复正常.
```
### 2.5 降级：善后
```
服务降级是一种为了保证整体可用性而忽略局部可用性的服务(有损)保护措施.
服务降级是从整体系统的负荷情况出发和考虑的，对某些负荷会比较高的情况，为了预防某些功能(业务场景)出现负荷过载或者响应慢的情况,在其内部暂时舍弃对一些非核心的接口和数据的请求,而直接返回一个提前准备好的fallback(退路)错误处理信息.
```
## 三、隔离手段
```
Hystrix通过线程池隔离的方式来对依赖(在Sentinel的概念中对应资源)进行了隔离.
这样做的好处是资源和资源之间做到了最彻底的隔离.缺点是除了增加线程切换的成本(过多的线程池导致线程数目过多),还需要预先给各个资源做线程池大小的分配.
```
### 3.1 通过并发线程数进行限制
```
和资源池隔离的方法不同,Sentinel通过限制资源并发线程的数量,来减少不稳定资源对其它资源的影响.这样不但没有线程切换的损耗,也不需要您预先分配线程池的大小.
当某个资源出现不稳定的情况下,例如响应时间变长,对资源的直接影响就是会造成线程数的逐步堆积.当线程数在特定资源上堆积到一定的数量之后,对该资源的新请求就会被拒绝,堆积的线程完成任务后才开始继续接收请求.
```
### 3.2 通过响应时间对资源进行降级
```
除了对并发线程数进行控制以外,Sentinel还可以通过响应时间来快速降级不稳定的资源.
当依赖的资源出现响应时间过长后,所有对该资源的访问都会被直接拒绝,直到过了指定的时间窗口之后才重新恢复.
```
## 四、流量控制
```
流量控制在网络传输中用于调整网络包发送数据速率的一种技术.
限流主要通过限制并发访问数(用户相关)或者一个时间窗口内请求数(非用户相关)所采取的一种系统保护措施，
当达到指定的阈值时对流量进行控制,以避免被瞬时的流量高峰冲垮,从而保障应用的高可用.
```
### 4.1 流控设计理念
```
Sentinel的设计理念是让您自由选择控制的角度并进行灵活组合，从而达到想要的效果，如下为流控的几个角度：
```
1. `资源的调用关系`：例如资源的调用链路，资源和资源之间的关系
2. `运行指标`：例如QPS、线程池、系统负载等
3. `控制的效果`：例如直接限流、冷启动、排队等
### 4.2 调用关系限流策略
```
调用关系包括调用方、被调用方；一个方法又可能会调用其它方法,形成一个调用链路的层次关系.
```
1. 调用方限流(`直接`)：`spring.cloud.sentinel.servlet.block-path={url}`
2. 调用链路入口限流(`链路`)：资源通过调用关系，相互之间构成一棵调用树
3. 关联流量控制(`关联`)：当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联
### 4.3 流控行为(ControlBehavior)：当QPS超过阈值时就会触发流控行为
1. 直接拒绝(`CONTROL_BEHAVIOR_DEFAULT`)：请求流量超出阈值,直接抛出FlowException
2. 预热(`CONTROL_BEHAVIOR_WARM_UP`)：当流量突然增大时(系统由空闲状态突然切换到繁忙状态),有可能瞬间把系统压垮,此方式是在一定时间内逐渐增加阈值
3. 匀速排队(`CONTROL_BEHAVIOR_RATE_LIMITER`)：控制请求在时间间隔内以均匀的速度通过,即为漏桶算法
4. 预热+匀速排队(`CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER`)
### 4.4 限流算法
1. `固定时间窗口算法`：限定时间周期内累加`访问次数`,当`访问次数`达到设定的阈值时触发限流策略,当进入下一个时间周期`访问次数`清零.这种算法存在一个`临界`问题.
2. `滑动时间窗口算法`：在固定时间窗口中分隔出多个`小时间窗口`,分别在分隔出的`小时间窗口`中记录`访问次数`,然后根据时间将`小时间窗口`往前滑动并删除过期的`小时间窗口`,最终统计所有`小点时间窗口`内的`访问次数`.
3. `令牌桶算法`：系统以一个恒定的速度往固定容量的令牌桶放入令牌,对于客户端每个请求都要先从令牌桶获取一个令牌(访问资格),如果未能获取则触发限流策略.
4. `漏桶算法`：控制数据注入网络的速度,平滑网络上的突发流量.系统在内部维护一个固定容量的容器,以恒定的速度出水,容器溢出则触发限流策略.
### 4.5 流控日志：每秒一条
1. 例子：`1608688315000|2020-12-23 09:51:55|HelloWorld|1|0|1|0|8|0|0|1`
2. 格式：`timestamp|yyyy-MM-dd HH:mm:ss.SSS|resource|passQPS|blockQPS|sucessQPS|exceptionQPS|RT|occupiedPassQPS|concurrency|classification`
3. `timestamp`：时间戳
4. `yyyy-MM-dd HH:mm:ss.SSS`：格式化的时间戳
5. `resource`：资源
6. `passQPS`：通过的请求数
7. `blockQPS`：被阻止的请求数
8. `sucessQPS`：成功执行完成的请求数
9. `exceptionQPS`：用户自定义的异常
10. `RT`：平均响应时间
11. `occupiedPassQPS`：优先通过的请求
12. `concurrency`：并发量
13. `classification`：资源类型
### 4.6 流控规则(FlowRule)
1. `resource`(资源名)：必填，限流保护的最基本元素
2. `limitApp`(调用来源)：默认是default(不区分调用来源),资源生效顺序：`{some_origin_name}->other-default`
3. `grade`(限流阈值类型)：0=并发线程数模式，1=QPS模式,默认是QPS模式
4. `count`(限流阈值)：必填
5. `strategy`(调用关系限流策略)：直接、链路、关联，默认是直接
6. `controlBehavior`(流控行为)：包括直接拒绝、排队等待、预热(慢启动)模式,默认是直接拒绝
7. `maxQueueingTimeMs`(最大排队等待时长)：仅在匀速排队模式生效
8. `warmUpPeriodSec`(预热间隔时长)：仅在预热(慢启动)模式生效
9. `clusterMode`(是否集群限流)：默认false
10. `clusterConfig`：集群流控相关配置
### 4.7 热点参数规则(ParamFlowRule)
1. `resource`(资源名)：必填,限流保护的最基本元素
2. `grade`(限流阈值类型)：0=并发线程数模式,1=QPS模式,默认是QPS模式
3. `count`(限流阈值)：必填
4. `durationInSec`(统计窗口时间长度)：单位为秒，默认是1s
5. `controlBehavior`(流控效果)：支持快速失败和匀速排队模式,默认是直接拒绝
6. `maxQueueingTimeMs`(最大排队等待时长)：仅在匀速排队模式生效,默认是0ms
7. `paramIdx`(热点参数的索引)：对应`SphU.entry(xxx, args)`中的参数索引位置
8. `paramFlowItemList`(参数例外项)：可以针对指定的参数值单独设置限流阈值,不受前面`count`阈值的限制.仅支持基本类型
9. `clusterMode`(是否集群限流)：默认false
10. `clusterConfig`：集群流控相关配置
### 4.8 系统自适应限流(SystemRule)
```
Sentinel系统自适应限流从整体维度对应用入口流量进行控制，结合应用的Load、CPU使用率、总体平均RT、入口QPS和并发线程数等几个维度的监控指标，
通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。
```
1. `grade`(限流阈值类型)：必填
  - Load自适应：系统的load1作为启发指标，进行自适应系统保护
  - RT：当单台机器上所有入口流量的`平均RT`达到阈值即触发系统保护，单位是毫秒
  - 线程数：当单台机器上所有入口流量的`并发线程数`达到阈值即触发系统保护
  - 入口QPS：当单台机器上所有`入口流量的QPS`达到阈值即触发系统保护
  - CPU使用率：当系统`CPU使用率`超过阈值即触发系统保护(取值范围 0.0-1.0)，比较灵敏
2. `count`(限流阈值)：必填
### 4.9 黑白名单控制(AuthorityRule)
```
很多时候，我们需要根据调用来源来判断该次请求是否允许放行，这时候可以使用Sentinel的来源访问控制(黑白名单控制)的功能。
来源访问控制根据资源的请求来源(origin)限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。
```
1. `resource`(资源名)：必填,限流保护的最基本元素
2. `limitApp`(调用来源)：对应的黑名单或白名单，不同origin用`,`分隔，如 appA,appB
3. `strategy`(限制模式)：`AUTHORITY_WHITE`为白名单模式，`AUTHORITY_BLACK`为黑名单模式，默认为白名单模式
## 五、熔断降级
```
服务熔断将暂时出现故障的接口隔离出来,断绝与外部接口的联系,当触发熔断后,后续一段时间内该服务调用者请求就会直接失败,直到目标服务恢复正常.
```
### 5.1 服务降级参考指标
1. 平均响应时间：
2. 异常比例：
3. 异常数量：
### 5.2 熔断策略
1. 慢调用比例(`SLOW_REQUEST_RATIO`)：请求的响应时间大于允许的慢调用`最大的响应时间RT(count)`的值则统计为慢调用.当`单位统计时长(statIntervalMs)`内请求数目大于设置的`最小请求数(minRequestAmount)`并且慢调用的比例大于`阈值(slowRatioThreshold)`，则接下来的`熔断时长(timeWindow)`内请求会自动被熔断.经过`熔断时长(timeWindow)`后熔断器会进入探测恢复状态(HALF-OPEN状态)，若接下来的一个请求响应时间小于设置的慢调用RT则结束熔断，若大于设置的慢调用`最大的响应时间RT(count)`则会再次被熔断
2. 异常比例(`ERROR_RATIO`)：当`单位统计时长(statIntervalMs)`内请求数目大于设置的`最小请求数(minRequestAmount)`并且异常的比例大于`阈值(count)`,则接下来的熔断时长内请求会自动被熔断.经过`熔断时长(timeWindow)`后熔断器会进入探测恢复状态(HALF-OPEN状态)，若接下来的一个请求成功完成(没有错误)则结束熔断，否则会再次被熔断.异常比率的阈值范围是`[0.0, 1.0]`，代表`0%-100%`.
3. 异常数(`ERROR_COUNT`)：当`单位统计时长(statIntervalMs)`内的异常数超过`阈值(count)`之后会自动进行熔断.经过`熔断时长(timeWindow)`后熔断器会进入探测恢复状态(HALF-OPEN状态)，若接下来的一个请求成功完成(没有错误)则结束熔断，否则会再次被熔断
### 5.3 熔断降级规则(DegradeRule)
1. `resource`(资源名)：必填,熔断的最基本元素
2. `grade`(熔断策略)：支持慢调用比例、异常比例、异常数.默认是慢调用比例
3. `count`(熔断阈值)：必填，慢调用比例模式下为慢调用临界值`RT(超出该值计为慢调用)`；异常比例或异常数模式下为对应的阈值
4. `timeWindow`(熔断降级的时间窗口)：熔断时长,单位为秒
5. `minRequestAmount`(触发异常熔断的最小请求数)：请求数小于该值时即使比例超出阈值也不会触发熔断(1.7.0 引入)
6. `statIntervalMs`(统计时长)：单位为ms,如`60*1000`代表分钟级(1.8.0 引入)
7. `slowRatioThreshold`(慢调用比例阈值)：仅慢调用比例模式有效(1.8.0 引入)
