# Sentinel(分布式系统的流量防卫兵)手册
## 一、前言
```
网关及业务系统在没有任何保护措施的情况下,如果出现突发流量冲击,大到后台系统所能承受的极限,近而导致整体系统不可用,从而造成巨大损失.
就流控单从本质上而言,是以牺牲部分用户的可用性为代价,来换取先入用户的可用性.
```
## 二、基础概念
### 2.1 资源
```
资源可以理解为应用程序中的任何内容,大则一个服务群、中则集群中的一个服务实例、小则服务内的一个URL请求路径或方法签名、微则一段代码块.
```
### 2.2 规则
```
围绕资源的实时状态设定的一系列规则,包括流量控制规则、熔断降级规则以、系统保护规则.
同一个资源可以创建多条限流规则.
```
## 三、流量控制
```
流量控制在网络传输中用于调整网络包发送数据速率的一种技术.
限流主要通过限制并发访问数(用户相关)或者一个时间窗口内请求数(非用户相关)所采取的一种系统保护措施，
当达到指定的阈值时对流量进行控制,以避免被瞬时的流量高峰冲垮,从而保障应用的高可用.
```
### 3.1 限流算法
1. `固定时间窗口算法`：限定时间周期内累加`访问次数`,当`访问次数`达到设定的阈值时触发限流策略,当进入下一个时间周期`访问次数`清零.这种算法存在一个`临界`问题.
2. `滑动时间窗口算法`：在固定时间窗口中分隔出多个`小时间窗口`,分别在分隔出的`小时间窗口`中记录`访问次数`,然后根据时间将`小时间窗口`往前滑动并删除过期的`小时间窗口`,最终统计所有`小点时间窗口`内的`访问次数`.
3. `令牌桶算法`：系统以一个恒定的速度往固定容量的令牌桶放入令牌,对于客户端每个请求都要先从令牌桶获取一个令牌(访问资格),如果未能获取则触发限流策略.
4. `漏桶算法`：控制数据注入网络的速度,平滑网络上的突发流量.系统在内部维护一个固定容量的容器,以恒定的速度出水,容器溢出则触发限流策略.
### 3.2 流控日志：每秒一条
1. 例子：`1608688315000|2020-12-23 09:51:55|HelloWorld|1|0|1|0|8|0|0|1`
2. 格式：`timestamp|yyyy-MM-dd HH:mm:ss.SSS|resource|passQPS|blockQPS|sucessQPS|exceptionQPS|RT|occupiedPassQPS|concurrency|classification`
3. `timestamp`：时间戳
4. `yyyy-MM-dd HH:mm:ss.SSS`：格式化的时间戳
5. `resource`：资源
6. `passQPS`：通过的请求数
7. `blockQPS`：被阻止的请求数
8. `sucessQPS`：成功执行完成的请求数
9. `exceptionQPS`：用户自定义的异常
10. `RT`：平均响应时间
11. `occupiedPassQPS`：优先通过的请求
12. `concurrency`：并发量
13. `classification`：资源类型
### 3.3 流控规则(FlowRule)
1. `resource`(资源名)：必填，限流保护的最基本元素
2. `limitApp`(调用来源)：默认是default(不区分调用来源),资源生效顺序：`{some_origin_name}->other-default`
2. `grade`(限流阈值类型)：0=并发线程数模式，1=QPS模式,默认是QPS模式
3. `count`(限流阈值)：必填
5. `strategy`(调用关系限流策略)：直接、链路、关联，默认是直接
6. `controlBehavior`(流控行为)：包括直接拒绝、排队等待、慢启动模式,默认是直接拒绝
7. `maxQueueingTimeMs`(最大排队等待时长)：仅在匀速排队模式生效
10. `clusterMode`(是否集群限流)：默认false
11. `clusterConfig`：集群流控相关配置
### 3.4 调用关系限流策略
```
调用关系包括调用方、被调用方；一个方法又可能会调用其它方法,形成一个调用链路的层次关系.
```
1. 调用方限流(`直接`)：`spring.cloud.sentinel.servlet.block-path={url}`
2. 调用链路入口限流(`链路`)：资源通过调用关系，相互之间构成一棵调用树
3. 关联流量控制(`关联`)：当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联
### 3.5 流控行为(ControlBehavior)：当QPS超过阈值时就会触发流控行为
1. 直接拒绝(`CONTROL_BEHAVIOR_DEFAULT`)：请求流量超出阈值,直接抛出FlowException
2. 预热(`CONTROL_BEHAVIOR_WARM_UP`)：当流量突然增大时(系统由空闲状态突然切换到繁忙状态),有可能瞬间把系统压垮,此方式是在一定时间内逐渐增加阈值
3. 匀速排队(`CONTROL_BEHAVIOR_RATE_LIMITER`)：控制请求在时间间隔内以均匀的速度通过,即为漏桶算法
4. 预热+匀速排队(`CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER`)
### 3.6 热点参数规则(ParamFlowRule)
1. `resource`(资源名)：必填,限流保护的最基本元素
2. `grade`(限流阈值类型)：0=并发线程数模式,1=QPS模式,默认是QPS模式
3. `count`(限流阈值)：必填
4. `durationInSec`(统计窗口时间长度)：单位为秒，默认是1s
5. `controlBehavior`(流控效果)：支持快速失败和匀速排队模式,默认是直接拒绝
6. `maxQueueingTimeMs`(最大排队等待时长)：仅在匀速排队模式生效,默认是0ms
7. `paramIdx`(热点参数的索引)：对应`SphU.entry(xxx, args)`中的参数索引位置
8. `paramFlowItemList`(参数例外项)：可以针对指定的参数值单独设置限流阈值,不受前面`count`阈值的限制.仅支持基本类型
9. `clusterMode`(是否集群限流)：默认false
10. `clusterConfig`：集群流控相关配置
### 3.7 系统自适应限流(SystemRule)
```
Sentinel系统自适应限流从整体维度对应用入口流量进行控制，结合应用的Load、CPU使用率、总体平均RT、入口QPS和并发线程数等几个维度的监控指标，
通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。
```
1. `grade`(限流阈值类型)：必填
  --- Load自适应
  --- CPU usage
  --- 平均RT
  --- 并发线程数
  --- 入口QPS
2. `count`(限流阈值)：必填
### 3.8 黑白名单控制(AuthorityRule)
```
很多时候，我们需要根据调用来源来判断该次请求是否允许放行，这时候可以使用Sentinel的来源访问控制(黑白名单控制)的功能。
来源访问控制根据资源的请求来源(origin)限制资源是否通过，若配置白名单则只有请求来源位于白名单内时才可通过；若配置黑名单则请求来源位于黑名单时不通过，其余的请求通过。
```
1. `resource`(资源名)：必填,限流保护的最基本元素
2. `limitApp`(调用来源)：对应的黑名单或白名单，不同origin用`,`分隔，如 appA,appB
3. `strategy`(限制模式)：`AUTHORITY_WHITE`为白名单模式，`AUTHORITY_BLACK`为黑名单模式，默认为白名单模式
## 五、熔断降级
```
服务熔断是实现服务降级的方案之一.
服务熔断指的是当某个服务提供者不能正常为服务调用者提供服务时,为了防止因局部服务故障近而导致出现雪崩效应所采取一种系统保护措施.
服务熔断将暂时出现故障的接口隔离出来,断绝与外部接口的联系,当触发熔断后,后续一段时间内该服务调用者请求就会直接失败,直到目标服务恢复正常.
```
### 5.1 服务降级参考指标
1. 平均响应时间：
2. 异常比例：
3. 异常数量：
### 5.2 熔断策略
1. 慢调用比例(`SLOW_REQUEST_RATIO`)：请求的响应时间大于允许的慢调用`RT(即最大的响应时间)`的值则统计为慢调用.
2. 异常比例(`ERROR_RATIO`)：当`单位统计时长(statIntervalMs)`内请求数目大于设置的`最小请求数`,并且异常的比例大于阈值,则接下来的熔断时长内请求会自动被熔断
3. 异常数(`ERROR_COUNT`)：当单位统计时长内的异常数超过阈值之后会自动进行熔断
### 5.3 熔断降级规则(DegradeRule)
1. `resource`(资源名)：必填,熔断的最基本元素
2. `grade`(熔断策略)：支持慢调用比例、异常比例、异常数.默认是慢调用比例
3. `count`(熔断阈值)：必填，慢调用比例模式下为慢调用临界值`RT(超出该值计为慢调用)`；异常比例或异常数模式下为对应的阈值
4. `timeWindow`(熔断降级的时间窗口)：熔断时长,单位为秒
5. `minRequestAmount`(触发异常熔断的最小请求数)：请求数小于该值时即使比例超出阈值也不会触发熔断(1.7.0 引入)
6. `statIntervalMs`(统计时长)：单位为ms,如`60*1000`代表分钟级(1.8.0 引入)
7. `slowRatioThreshold`(慢调用比例阈值)：仅慢调用比例模式有效(1.8.0 引入)
