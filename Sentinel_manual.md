# Sentinel(分布式系统的流量防卫兵)手册
## 一、前言
```
网关及业务系统在没有任何保护措施的情况下,如果出现突发流量冲击,大到后台系统所能承受的极限,近而导致整体系统不可用,从而造成巨大损失.
就流控单从本质上而言,是以牺牲部分用户的可用性为代价,来换取先入用户的可用性.
```
## 二、基础概念
### 2.1 资源
```
资源可以理解为Java应用程序中的任何内容,大则一个服务群、中则集群中的一个服务实例、小则服务内的一个URL请求路径或方法签名、微则一段代码块.

```
### 2.2 规则
```
围绕资源的实时状态设定的一系列规则,包括流量控制规则、熔断降级规则以、系统保护规则.
所有规则可以动态实时调整.
```
### 2.3 流量控制
```
流量控制在网络传输中是一个常用的概念,它用于调整网络包的发送数据.
```
### 2.4 熔断降级
```
对调用链路中的不稳定因素进行熔断(保护).
```
## 三、配置项
### 3.1 启动配置项
|    名称   |     含义      |   是否必填  | 默认值       |
| --------- | ------------ |------------ |------------ |
|    project.name   |     指定程序的名称      |   否  | null      |
### 3.2 sentinel-transport-common配置项

### 3.3 相关配置项
## 四、限流
```
限流主要通过限制并发访问数(用户相关)或者一个时间窗口内请求数(非用户相关)所采取一种系统保护措施.
```
### 4.1 限流算法
1. `固定时间窗口算法`：限定时间周期内累加`访问次数`,当`访问次数`达到设定的阈值时触发限流策略,当进入下一个时间周期`访问次数`清零.这种算法存在一个`临界`问题.
2. `滑动时间窗口算法`：在固定时间窗口中分隔出多个`小时间窗口`,分别在分隔出的`小时间窗口`中记录`访问次数`,然后根据时间将`小时间窗口`往前滑动并删除过期的`小时间窗口`,最终统计所有`小点时间窗口`内的`访问次数`.
3. `令牌桶算法`：系统以一个恒定的速度往固定容量的令牌桶放入令牌,对于客户端每个请求都要先从令牌桶获取一个令牌(访问资格),如果未能获取则触发限流策略.
4. `漏桶算法`：控制数据注入网络的速度,平滑网络上的突发流量.系统在内部维护一个固定容量的容器,以恒定的速度出水,容器溢出则触发限流策略.
### 4.2 限流策略
1. 转到错误页面：`spring.cloud.sentinel.servlet.block-path={url}`
2. 排队等待
3. 降级(快速失败)
### 4.3 流控规则(FlowRule)：时间单位(秒)
1. `resource`(资源名)：必填,限流保护的最基本元素,比如一个方法
2. `grade`(限流阈值类型)：0=并发线程数模式,1=QPS模式,默认是QPS模式
3. `count`(限流阈值)：必填
4. `limitApp`(调用来源)：默认是default(不区分调用来源),资源生效顺序：`{some_origin_name}->other-default`
5. `strategy`(调用关系限流策略)：直接、链路、关联,默认是
6. `controlBehavior`(流控行为)：包括直接拒绝、排队等待、慢启动模式,默认是直接拒绝
7. `maxQueueingTimeMs`(最大排队等待时长)：仅在匀速排队模式生效
8. `paramIdx`(热点参数索引)：对应`SphU.entry(xxx, args)`中的参数索引位置
9. `paramFlowItemList`(参数例外项)：可以针对指定的参数值单独设置限流阈值,不受前面`count`阈值的限制.仅支持基本类型
10. `clusterMode`(是否集群限流)：默认false
11. `clusterConfig`：集群流控相关配置
### 4.4 流控行为(ControlBehavior)：当QPS超过阈值时就会触发流控行为
1. 直接拒绝(`CONTROL_BEHAVIOR_DEFAULT`)：请求流量超出阈值,直接抛出FlowException
2. 预热(`CONTROL_BEHAVIOR_WARM_UP`)：当流量突然增大时(系统由空闲状态突然切换到繁忙状态),有可能瞬间把系统压垮,此方式是在一定时间内逐渐增加阈值
3. 匀速排队(`CONTROL_BEHAVIOR_RATE_LIMITER`)：控制请求在时间间隔内以均匀的速度通过,即为漏桶算法
4. 预热+匀速排队(`CONTROL_BEHAVIOR_WARM_UP_RATE_LIMITER`)
### 4.5 流控日志：每秒一条
1. 例子：`1608688315000|2020-12-23 09:51:55|HelloWorld|1|0|1|0|8|0|0|1`
2. 格式：`timestamp|yyyy-MM-dd HH:mm:ss.SSS|resource|passQPS|blockQPS|sucessQPS|exceptionQPS|RT|occupiedPassQPS|concurrency|classification`
3. `timestamp`：时间戳
4. `yyyy-MM-dd HH:mm:ss.SSS`：格式化的时间戳
5. `resource`：资源
6. `passQPS`：通过的请求数
7. `blockQPS`：被阻止的请求数
8. `sucessQPS`：成功执行完成的请求数
9. `exceptionQPS`：用户自定义的异常
10. `RT`：平均响应时间
11. `occupiedPassQPS`：优先通过的请求
12. `concurrency`：并发量
13. `classification`：资源类型
## 五、降级
```
服务熔断是实现服务降级的方案之一.
服务熔断指的是当某个服务提供者不能正常为服务调用者提供服务时,为了防止因局部服务故障近而导致出现雪崩效应所采取一种系统保护措施.
服务熔断将暂时出现故障的接口隔离出来,断绝与外部接口的联系,当触发熔断后,后续一段时间内该服务调用者请求就会直接失败,直到目标服务恢复正常.
```
### 5.1 服务降级参考指标
1. 平均响应时间：
2. 异常比例：
3. 异常数量：
### 5.2 降级策略
1. RT：
2. 异常比例：
3. 异常数：
### 5.3 降级规则(DegradeRule)：时间单位(秒)
1. `resource`(资源名)：必填,熔断的最基本元素,比如一个方法
2. `grade`(熔断策略)：支持秒级RT、秒级异常比例、分钟级异常数.默认是秒级RT
3. `count`(熔断阈值)：必填
4. `timeWindow`(熔断降级的时间窗口)：触发熔断降级后多长时间内自动熔断
5. `minRequestAmount`(触发异常熔断的最小请求数)：请求数小于该值时即使比例超出阈值也不会触发熔断
